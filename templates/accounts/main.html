{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Careat</title>

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  
</head>
<body>
 <!-- top-bar -->
  <div class="title-row">
    <h2 class="title-text">ì‹ë‹¨ ê¸°ë¡</h2>
    <a href="{% url 'accounts:mypage' %}">
      <img class="icon" src="{% static 'images/profile.png' %}" alt="profile" />
    </a>
  </div>
<!-- ë‚ ì§œ ì„ íƒ -->
<div class="calendar">
  <div class="date_text" id="month-text"></div>
  <div class="date_select" id="date-select">
  </div>
</div>

<!-- ì¹¼ë¡œë¦¬ ê³„ì‚° -->
<div class="calory-num">
  <h2 class="calory-focus-num" id="current-kcal">0 </h2> 
  <h2 class="calory-unfocus-num">&nbsp;/ <span id="goal-kcal">1420 </span> kcal</h2> 
</div>
    <!-- ì¹¼ë¡œë¦¬ ë°” -->
    <div class="bar">
    <div class="bar-wrapper">
        <div class="bar-fill" style="width: 80%"></div>
    </div>
    </div>
    <!-- ìƒì„¸ ì¹¼ë¡œë¦¬ -->
    <div class="calorys">
    <div class="calory">
        <div><p>ìˆœíƒ„ìˆ˜</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/180g</span>
    </div>
    <div class="calory">
        <div><p>ë‹¨ë°±ì§ˆ</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/75g</span>
    </div>
    <div class="calory">
        <div><p>ì§€ë°©</p></div>
    <span>0<span style="color:#888888">/45g</span>
    </div>
    </div>

 <!-- ì‹ë‹¨ ì¶”ê°€    -->
<h2 class="title-text" style="margin-top: 50px;">ì‹ë‹¨ ì¶”ê°€</h2>

<div class="meal-list">
    <div class="meal-item">
        <span class="meal-name">ì•„ì¹¨</span>
        <span class="meal-kcal empty">0Kcal</span>
        <span class="meal-add" data-meal="ì•„ì¹¨">+</span>
    </div>
</div>
    <div class="meal-item">
      <span class="meal-name">ì ì‹¬</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ì ì‹¬">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">ì €ë…</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ì €ë…">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">ê°„ì‹</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ê°„ì‹">+</span>
    </div>
  </div>
  
<!-- ì‹ë‹¨ í”¼ë“œë°± -->
<div class="feedback">
  <div class="feedback-toggle" onclick="toggleFeedback()">
    <span class="label">ì‹ë‹¨ í”¼ë“œë°±</span>
    <img id="feedback-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
  </div>

    <!-- ì‹ë‹¨ íŒë„¬ -->
    <div id="feedback-panel" class="feedback-panel">
        <p class="suggest_text1">{{ user.username }}ë‹˜ì˜ ì‹ë‹¨ ìœ í˜•ì€ <span class="highlight">ë‹¹ ê³¼ë‹¤í˜•</span>ì´ì—ìš”.<br>
        ë‹¹ë¥˜ë¥¼ ì¤„ì´ë©´ ë¹ ë¥¸ ì²´ì¤‘ê°ëŸ‰ì— ë„ë‹¬í•  ìˆ˜ ìˆì–´ìš”!</p>

        <p class="suggest_text2">ê°„ì‹ì„ í•œë²ˆì— ì¤„ì´ê¸° ì–´ë µë‹¤ë©´ <br> ì´ëŸ° ê°„ì‹ì€ ì–´ë•Œìš”?</p>
    
        <div class="suggestions">
        <div class="item">
            <div class="suggest_img">
               <a href="https://lalasweet.kr/product/%EB%9D%BC%EB%9D%BC%EC%8A%A4%EC%9C%97-%EC%A0%80%EB%8B%B9-%EB%AA%A8%EB%82%98%EC%B9%B4-16%EA%B0%9C/29/">
                 <img src="{% static 'images/lalaswit.png' %}" alt="ë¼ë¼ìŠ¤ìœ—">
            </div>
            <div class="item-text">ë¼ë¼ìŠ¤ìœ— ì €ë‹¹ ëª¨ë‚˜ì¹´</div></a>
            <div class="item-num">2,500ì›</div>
            </div>
            <div class="item">
                <div class="suggest_img">
                    <a href="https://mynormal.shop/shop_view/?idx=13&srsltid=AfmBOoq3jk2QJOFGQ4R7DyiYjQhVqsR6JmPiGrmWe9dsYGmdnzuiHyTo">
                        <img src="{% static 'images/mynormal.png' %}" alt="ë§ˆì´ë…¸ë©€">
                </div>
                <div class="item-text">ë§ˆì´ë…¸ë©€ ì €ë‹¹ ì•„ì´ìŠ¤í¬ë¦¼ íŒŒì¸íŠ¸ 474ml</div></a>
                <div class="item-num">2,500ì›</div>
                </div>
                <div class="item">
                    <div class="suggest_img">
                        <a href="https://mynormal.shop/shop_view/?idx=301&srsltid=AfmBOopVXg_PnIVeC-23-l3JJosuGsy7xZ0J8XDhxbL_nXQpsHVszyMk">
                            <img src="{% static 'images/greentea.png' %}" alt="ê·¸ë¦°í‹°">
                    </div>
                    <div class="item-text">ë§ˆì´ë…¸ë©€ ì €ë‹¹ ë§ì°¨ ì•„ëª¬ ì´ˆì½”ë³¼ 1ë°•ìŠ¤... </div></a>
                    <div class="item-num">11,900ì›</div>
                    </div>
        </div>
    </div>
</div>

<!-- ìš´ë™ ì¶”ì²œ -->
<div class="exercise">
    <div class="exercise-toggle" onclick="toggleexercise()">
      <span class="label">ìš´ë™ ì¶”ì²œ </span>
      <img id="exercise-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
    </div>
    <!-- ìš´ë™ ì¶”ì²œ íŒë„¬ -->
    <div id="exercise-panel" class="exercise-panel">
        <p class="suggest_text1">{{ user.username }}ë‹˜! ì˜¤ëŠ˜ì€ ê°„ì‹ì„ ë§ì´ ë“œì…¨ìœ¼ë‹ˆ <br> <span class="highlight">ìœ ì‚°ì†Œ ìš´ë™</span>ì–´ë– ì‹ ê°€ìš”?</p>
        <div class="youtube_section">
            <div class="exercise-title">ì§€ë°©íƒ€íŒŒ ê³ ê°•ë„ ìœ ì‚°ì†Œ</div>
            <div class="card-slider">
                <div class="card">
                    <a href="https://www.youtube.com/watch?v=5bukb6aeobs"><img src="{% static 'images/youtube1.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ì˜¬ ê²ƒì´ ì™”ë‹¤... ë„ì „ í•´ë³´ì„¸ìš” <br> - 20ë¶„ğŸ”¥ ë•€ìƒ¤ì›Œ ê³ ê°•ë„ ì¸... </div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">ë¹…ì”¨ìŠ¤ Bigsis</div>
                    </div>
                </div>
                <div class="card">
                    <a href="https://www.youtube.com/results?search_query=%EB%AC%B4%EC%84%9C%EC%9A%B4+%EC%86%8D%EB%8F%84%EB%A1%9C+%EB%B9%A0%EC%A7%80%EB%8A%94"><img src="{% static 'images/youtube2.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ë¬´ì„œìš´ ì†ë„ë¡œ ì‚´ë¹ ì§€ëŠ” ìš´ë™<br>ğŸ”¥ì´ ìš´ë™ ë”± 3ì£¼ë§Œ í•´ë³´ì„¸ìš”...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">í™ë‘¥ì´</div>
                    </div>
                </div>

                <div class="card">
                    <a href="https://www.youtube.com/watch?v=S4xfkLMJdwI"><img src="{% static 'images/youtube3.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ì •ë§ ë¬´ì„œìš´ ì†ë„ë¡œ ì‚´ì´ ë¹ ì§€<br>ëŠ” ê·¹ê°•ì˜ ìœ ì‚°ì†Œ -41kg ê¹Œ...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">ì—ì´í• afit</div>
                    </div>
                </div>
            </div>
            </div>

            <div class="youtube_section">
                <div class="exercise-title">NO ì¸µê°„ì†ŒìŒ! ê°€ë²¼ìš´ ìœ ì‚°ì†Œ</div>
                <div class="card-slider">
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=0IWibGOf1jU"><img src="{% static 'images/youtube4.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <div class="card-title">ëª¸ ë¬´ê±°ìš´ ì›”ìš”ì¼ - ê°€ë³ê²Œ ë¶€<br>ë‹´ì—†ì´ 28ë¶„ ì¸µê°„ì†ŒìŒ ì—†ëŠ”...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">ë¹…ì”¨ìŠ¤ Bigsis</div>
                        </div>
                    </div>
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=s82_Hi_5ItA"><img src="{% static 'images/youtube5.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <div class="card-title">ì‚´ì´ ì´ë ‡ê²Œë‚˜ ë¹ ì§„ë‹¤êµ¬?! ì¸µ<br>ê°„ì†ŒìŒâŒ ì§€ë°© íƒœìš°ê¸°ğŸ”¥ No...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">MIZI</div>
                        </div>
                    </div>
    
                    <div class="card">
                        <img src="{% static 'images/youtube6.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <a href="https://www.youtube.com/watch?v=cl5cc1_5zZc"><div class="card-title">ì¸µê°„ ì†ŒìŒ ê±±ì • ì—†ì´ ì²´ì¤‘ ê°ëŸ‰<br>ë³´ì¥! ë”± 5ë¶„ ìš´ë™!</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">ì—¬ë¦¬ë‹ˆí•</div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
</div>

<script>
    
function getTodayDate() {
    const today = new Date();
    return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
}

function goToSearch(e) {
    const meal = e.target.dataset.meal;
    const searchUrl = "{% url 'accounts:search' %}";
    console.log("ì´ë™í•  ê²½ë¡œ:", `${searchUrl}?meal=${encodeURIComponent(meal)}`);
    location.href = `${searchUrl}?meal=${encodeURIComponent(meal)}`;
}





window.addEventListener("DOMContentLoaded", () => {
  // ì£¼ê°„ ë‚ ì§œ ë Œë”ë§ ë° ì„ íƒ ë‚ ì§œ ì„¤ì •
  const today = new Date();
  const monthText = document.getElementById("month-text");
  const dateSelect = document.getElementById("date-select");
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay()); // ì´ë²ˆì£¼ ì¼ìš”ì¼

  monthText.textContent = `${today.getMonth() + 1}ì›”`;

  for (let i = 0; i < 7; i++) {
    const currentDay = new Date(startOfWeek);
    currentDay.setDate(startOfWeek.getDate() + i);

    const date = currentDay.getDate();
    const isToday = currentDay.toDateString() === today.toDateString();
    const dayText = isToday ? "ì˜¤ëŠ˜" : weekdays[i];

    const year = currentDay.getFullYear();
    const month = String(currentDay.getMonth() + 1).padStart(2, '0');
    const day = String(currentDay.getDate()).padStart(2, '0');
    const dateKey = `${year}-${month}-${day}`;

    const dayDiv = document.createElement("div");
    dayDiv.className = "day";

    // localStorage ì €ì¥ëœ ë‚ ì§œì™€ ë¹„êµí•´ì„œ í™œì„±í™” í‘œì‹œ
    const savedSelectedDate = localStorage.getItem("selectedDate");
    if (savedSelectedDate === dateKey || (!savedSelectedDate && isToday)) {
      dayDiv.classList.add("active");
      if (!savedSelectedDate) localStorage.setItem("selectedDate", dateKey); // ê¸°ë³¸ê°’ ì €ì¥
    }

    dayDiv.innerHTML = `
      <div>${date}</div>
      <div class="day_text">${dayText}</div>
    `;

    dayDiv.addEventListener("click", () => {
      document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
      dayDiv.classList.add("active");
      localStorage.setItem("selectedDate", dateKey);
      location.reload(); // ë‚ ì§œ ë°”ë€Œë©´ ìƒˆë¡œê³ ì¹¨í•´ì„œ ë°ì´í„° ê°±ì‹ 
    });

    dateSelect.appendChild(dayDiv);
  }

  document.querySelectorAll('.meal-add').forEach(btn => {
  btn.addEventListener('click', () => {
    const meal = btn.getAttribute('data-meal');
    const selectedDate = localStorage.getItem("selectedDate") || getTodayDate();
    const existingMeals = JSON.parse(localStorage.getItem(`meals-${selectedDate}-${meal}`)) || [];

    localStorage.setItem('selectedMeal', meal);

    if (existingMeals.length > 0) {
      // ê¸°ì¡´ ì‹ë‹¨ì´ ìˆìœ¼ë©´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = '/accounts/meal-edit/';
    } else {
      // ìƒˆë¡œìš´ ì‹ë‹¨ ë“±ë¡ì´ë©´ ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = `/accounts/search/?meal=${encodeURIComponent(meal)}`;
    }
  });
});

  // ë©”ì¸ í™”ë©´ ì‹ì‚¬ë³„ ì¹¼ë¡œë¦¬ ê³„ì‚° ë° í‘œì‹œ
  const mealTypes = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ê°„ì‹'];
  const selectedDate = localStorage.getItem("selectedDate") || getTodayDate();
  let totalKcal = 0;

  mealTypes.forEach(meal => {
    const meals = JSON.parse(localStorage.getItem(`meals-${selectedDate}-${meal}`)) || [];
    const mealKcal = meals.reduce((acc, cur) => {
      const kcal = parseFloat(cur.kcal?.replace(/[^\d.]/g, '')) || 0;
      return acc + kcal;
    }, 0);

    const kcalSpan = [...document.querySelectorAll('.meal-item')].find(
      item => item.querySelector('.meal-name')?.textContent === meal
    )?.querySelector('.meal-kcal');

    if (kcalSpan) {
      kcalSpan.textContent = `${mealKcal}Kcal`;
      kcalSpan.classList.toggle('empty', mealKcal === 0);
    }

    totalKcal += mealKcal;
  });

  document.querySelector('.calory-focus-num').textContent = totalKcal;

  // ì¹¼ë¡œë¦¬ ëª©í‘œ ëŒ€ë¹„ ì§„í–‰ë¥  ë°”
  const targetKcal = 1420;
  const percent = Math.min((totalKcal / targetKcal) * 100, 100);
  document.querySelector('.bar-fill').style.width = `${percent}%`;


  // ëª©í‘œ ì¹¼ë¡œë¦¬ ë°” ë Œë”ë§ (ì¶”ê°€: current-kcal, goal-kcal ì—˜ë¦¬ë¨¼íŠ¸ ìˆì„ ê²½ìš°)
  const currentEl = document.getElementById("current-kcal");
  const goalEl = document.getElementById("goal-kcal");
  if(currentEl && goalEl){
    const current = parseInt(currentEl.textContent.trim(), 10);
    const goal = parseInt(goalEl.textContent.trim(), 10);
    const barPercent = Math.min((current / goal) * 100, 100);
    const caloryBar = document.getElementById("calory-bar");
    if(caloryBar){
      caloryBar.style.width = `${barPercent}%`;
    }
  }
});

// í† ê¸€ í•¨ìˆ˜: í”¼ë“œë°± íŒ¨ë„
function toggleFeedback() {
  const panel = document.getElementById("feedback-panel");
  const arrow = document.getElementById("feedback-arrow-icon");
  const isOpen = panel.style.display === "block";
  panel.style.display = isOpen ? "none" : "block";
  arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
  arrow.alt = isOpen ? "ì—´ê¸° ì•„ì´ì½˜" : "ë‹«ê¸° ì•„ì´ì½˜";
}

// í† ê¸€ í•¨ìˆ˜: ìš´ë™ íŒ¨ë„
function toggleexercise() {
  const panel = document.getElementById("exercise-panel");
  const arrow = document.getElementById("exercise-arrow-icon");
  const isOpen = panel.style.display === "block";
  panel.style.display = isOpen ? "none" : "block";
  arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
  arrow.alt = isOpen ? "ì—´ê¸° ì•„ì´ì½˜" : "ë‹«ê¸° ì•„ì´ì½˜";

  // ê°•ì œ ë¦¬í”Œë¡œìš° ì²˜ë¦¬ (í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€ìš©)
  arrow.style.display = "none";
  void arrow.offsetHeight;
  arrow.style.display = "";
}

</script>
    
</body>

</html>
