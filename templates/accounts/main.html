{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Careat</title>

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  
</head>
<body>
 <!-- top-bar -->
  <div class="title-row">
    <h2 class="title-text">ì‹ë‹¨ ê¸°ë¡</h2>
    <a href="{% url 'accounts:mypage' %}">
      <img class="icon" src="{% static 'images/profile.png' %}" alt="profile" />
    </a>
  </div>
<!-- ë‚ ì§œ ì„ íƒ -->
<div class="calendar">
  <div class="date_text" id="month-text"></div>
  <div class="date_select" id="date-select">
  </div>
</div>

<!-- ì¹¼ë¡œë¦¬ ê³„ì‚° -->
<div class="calory-num">
  <h2 class="calory-focus-num" id="current-kcal">0 </h2> 
  <h2 class="calory-unfocus-num">&nbsp;/ <span id="goal-kcal">1420 </span> kcal</h2> 
</div>
    <!-- ì¹¼ë¡œë¦¬ ë°” -->
    <div class="bar">
    <div class="bar-wrapper">
        <div class="bar-fill" style="width: 80%"></div>
    </div>
    </div>
    <!-- ìƒì„¸ ì¹¼ë¡œë¦¬ -->
    <div class="calorys">
    <div class="calory">
        <div><p>ìˆœíƒ„ìˆ˜</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/180g</span>
    </div>
    <div class="calory">
        <div><p>ë‹¨ë°±ì§ˆ</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/75g</span>
    </div>
    <div class="calory">
        <div><p>ì§€ë°©</p></div>
    <span>0<span style="color:#888888">/45g</span>
    </div>
    </div>

 <!-- ì‹ë‹¨ ì¶”ê°€    -->
<h2 class="title-text" style="margin-top: 50px;">ì‹ë‹¨ ì¶”ê°€</h2>

<div class="meal-list">
    <div class="meal-item">
        <span class="meal-name">ì•„ì¹¨</span>
        <span class="meal-kcal empty">0Kcal</span>
        <span class="meal-add" data-meal="ì•„ì¹¨">+</span>
    </div>
</div>
    <div class="meal-item">
      <span class="meal-name">ì ì‹¬</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ì ì‹¬">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">ì €ë…</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ì €ë…">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">ê°„ì‹</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="ê°„ì‹">+</span>
    </div>
  </div>
  
<!-- ì‹ë‹¨ í”¼ë“œë°± -->
<div class="feedback">
  <div class="feedback-toggle" onclick="toggleFeedback()">
    <span class="label">ì‹ë‹¨ í”¼ë“œë°±</span>
    <img id="feedback-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
  </div>

    <!-- ì‹ë‹¨ íŒë„¬ -->
    <div id="feedback-panel" class="feedback-panel">
        <p class="suggest_text1">{{ user.username }}ë‹˜ì˜ ì‹ë‹¨ ìœ í˜•ì€ <span class="highlight">ë‹¹ ê³¼ë‹¤í˜•</span>ì´ì—ìš”.<br>
        ë‹¹ë¥˜ë¥¼ ì¤„ì´ë©´ ë¹ ë¥¸ ì²´ì¤‘ê°ëŸ‰ì— ë„ë‹¬í•  ìˆ˜ ìˆì–´ìš”!</p>

        <p class="suggest_text2">ê°„ì‹ì„ í•œë²ˆì— ì¤„ì´ê¸° ì–´ë µë‹¤ë©´ <br> ì´ëŸ° ê°„ì‹ì€ ì–´ë•Œìš”?</p>
    
        <div class="suggestions">
        <div class="item">
            <div class="suggest_img">
               <a href="https://lalasweet.kr/product/%EB%9D%BC%EB%9D%BC%EC%8A%A4%EC%9C%97-%EC%A0%80%EB%8B%B9-%EB%AA%A8%EB%82%98%EC%B9%B4-16%EA%B0%9C/29/">
                 <img src="{% static 'images/lalaswit.png' %}" alt="ë¼ë¼ìŠ¤ìœ—">
            </div>
            <div class="item-text">ë¼ë¼ìŠ¤ìœ— ì €ë‹¹ ëª¨ë‚˜ì¹´</div></a>
            <div class="item-num">2,500ì›</div>
            </div>
            <div class="item">
                <div class="suggest_img">
                    <a href="https://mynormal.shop/shop_view/?idx=13&srsltid=AfmBOoq3jk2QJOFGQ4R7DyiYjQhVqsR6JmPiGrmWe9dsYGmdnzuiHyTo">
                        <img src="{% static 'images/mynormal.png' %}" alt="ë§ˆì´ë…¸ë©€">
                </div>
                <div class="item-text">ë§ˆì´ë…¸ë©€ ì €ë‹¹ ì•„ì´ìŠ¤í¬ë¦¼ íŒŒì¸íŠ¸ 474ml</div></a>
                <div class="item-num">2,500ì›</div>
                </div>
                <div class="item">
                    <div class="suggest_img">
                        <a href="https://mynormal.shop/shop_view/?idx=301&srsltid=AfmBOopVXg_PnIVeC-23-l3JJosuGsy7xZ0J8XDhxbL_nXQpsHVszyMk">
                            <img src="{% static 'images/greentea.png' %}" alt="ê·¸ë¦°í‹°">
                    </div>
                    <div class="item-text">ë§ˆì´ë…¸ë©€ ì €ë‹¹ ë§ì°¨ ì•„ëª¬ ì´ˆì½”ë³¼ 1ë°•ìŠ¤... </div></a>
                    <div class="item-num">11,900ì›</div>
                    </div>
        </div>
    </div>
</div>

<!-- ìš´ë™ ì¶”ì²œ -->
<div class="exercise">
    <div class="exercise-toggle" onclick="toggleexercise()">
      <span class="label">ìš´ë™ ì¶”ì²œ </span>
      <img id="exercise-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
    </div>
    <!-- ìš´ë™ ì¶”ì²œ íŒë„¬ -->
    <div id="exercise-panel" class="exercise-panel">
        <p class="suggest_text1">{{ user.username }}ë‹˜! ì˜¤ëŠ˜ì€ ê°„ì‹ì„ ë§ì´ ë“œì…¨ìœ¼ë‹ˆ <br> <span class="highlight">ìœ ì‚°ì†Œ ìš´ë™</span>ì–´ë– ì‹ ê°€ìš”?</p>
        <div class="youtube_section">
            <div class="exercise-title">ì§€ë°©íƒ€íŒŒ ê³ ê°•ë„ ìœ ì‚°ì†Œ</div>
            <div class="card-slider">
                <div class="card">
                    <a href="https://www.youtube.com/watch?v=5bukb6aeobs"><img src="{% static 'images/youtube1.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ì˜¬ ê²ƒì´ ì™”ë‹¤... ë„ì „ í•´ë³´ì„¸ìš” <br> - 20ë¶„ğŸ”¥ ë•€ìƒ¤ì›Œ ê³ ê°•ë„ ì¸... </div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">ë¹…ì”¨ìŠ¤ Bigsis</div>
                    </div>
                </div>
                <div class="card">
                    <a href="https://www.youtube.com/results?search_query=%EB%AC%B4%EC%84%9C%EC%9A%B4+%EC%86%8D%EB%8F%84%EB%A1%9C+%EB%B9%A0%EC%A7%80%EB%8A%94"><img src="{% static 'images/youtube2.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ë¬´ì„œìš´ ì†ë„ë¡œ ì‚´ë¹ ì§€ëŠ” ìš´ë™<br>ğŸ”¥ì´ ìš´ë™ ë”± 3ì£¼ë§Œ í•´ë³´ì„¸ìš”...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">í™ë‘¥ì´</div>
                    </div>
                </div>

                <div class="card">
                    <a href="https://www.youtube.com/watch?v=S4xfkLMJdwI"><img src="{% static 'images/youtube3.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                    <div class="card-title">ì •ë§ ë¬´ì„œìš´ ì†ë„ë¡œ ì‚´ì´ ë¹ ì§€<br>ëŠ” ê·¹ê°•ì˜ ìœ ì‚°ì†Œ -41kg ê¹Œ...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                        <div class="youtube-title">ì—ì´í• afit</div>
                    </div>
                </div>
            </div>
            </div>

            <div class="youtube_section">
                <div class="exercise-title">NO ì¸µê°„ì†ŒìŒ! ê°€ë²¼ìš´ ìœ ì‚°ì†Œ</div>
                <div class="card-slider">
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=0IWibGOf1jU"><img src="{% static 'images/youtube4.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <div class="card-title">ëª¸ ë¬´ê±°ìš´ ì›”ìš”ì¼ - ê°€ë³ê²Œ ë¶€<br>ë‹´ì—†ì´ 28ë¶„ ì¸µê°„ì†ŒìŒ ì—†ëŠ”...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">ë¹…ì”¨ìŠ¤ Bigsis</div>
                        </div>
                    </div>
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=s82_Hi_5ItA"><img src="{% static 'images/youtube5.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <div class="card-title">ì‚´ì´ ì´ë ‡ê²Œë‚˜ ë¹ ì§„ë‹¤êµ¬?! ì¸µ<br>ê°„ì†ŒìŒâŒ ì§€ë°© íƒœìš°ê¸°ğŸ”¥ No...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">MIZI</div>
                        </div>
                    </div>
    
                    <div class="card">
                        <img src="{% static 'images/youtube6.png' %}" alt="ê·¹ê°•ì˜ ìœ ì‚°ì†Œ"/>
                        <a href="https://www.youtube.com/watch?v=cl5cc1_5zZc"><div class="card-title">ì¸µê°„ ì†ŒìŒ ê±±ì • ì—†ì´ ì²´ì¤‘ ê°ëŸ‰<br>ë³´ì¥! ë”± 5ë¶„ ìš´ë™!</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="ë¹…ì”©ìŠ¤"></img>
                            <div class="youtube-title">ì—¬ë¦¬ë‹ˆí•</div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8000/api/diet';
    
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function getTodayDate() {
      const today = new Date();
      return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    }

    function goToSearch(e) {
      const meal = e.target.dataset.meal;
      const searchUrl = "{% url 'accounts:search' %}";
      console.log("ì´ë™í•  ê²½ë¡œ:", `${searchUrl}?meal=${encodeURIComponent(meal)}`);
      location.href = `${searchUrl}?meal=${encodeURIComponent(meal)}`;
    }

    async function fetchDietList(date) {
      try {
        const response = await fetch(`${API_BASE_URL}/?date=${date}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.error("ì‹ë‹¨ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.status);
          return [];
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        return [];
      }
    }

    async function fetchDailyCalories(date) {
      try {
        const response = await fetch(`${API_BASE_URL}/calories/?date=${date}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.error("ì¼ì¼ ì¹¼ë¡œë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.status);
          return null;
        }
        
        return await response.json();
      } catch (error) {
        console.error("ì¹¼ë¡œë¦¬ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        return null;
      }
    }

    const timeSlotMapping = {
      'ì•„ì¹¨': 'breakfast',
      'ì ì‹¬': 'lunch', 
      'ì €ë…': 'dinner',
      'ê°„ì‹': 'snack'
    };

    const timeSlotReverseMapping = {
      'breakfast': 'ì•„ì¹¨',
      'lunch': 'ì ì‹¬',
      'dinner': 'ì €ë…', 
      'snack': 'ê°„ì‹'
    };

    window.addEventListener("DOMContentLoaded", async () => {
      const today = new Date();
      const monthText = document.getElementById("month-text");
      const dateSelect = document.getElementById("date-select");
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());

      monthText.textContent = `${today.getMonth() + 1}ì›”`;

      for (let i = 0; i < 7; i++) {
        const currentDay = new Date(startOfWeek);
        currentDay.setDate(startOfWeek.getDate() + i);

        const date = currentDay.getDate();
        const isToday = currentDay.toDateString() === today.toDateString();
        const dayText = isToday ? "ì˜¤ëŠ˜" : weekdays[i];

        const year = currentDay.getFullYear();
        const month = String(currentDay.getMonth() + 1).padStart(2, '0');
        const day = String(currentDay.getDate()).padStart(2, '0');
        const dateKey = `${year}-${month}-${day}`;

        const dayDiv = document.createElement("div");
        dayDiv.className = "day";

        // localStorageì—ì„œ ì„ íƒëœ ë‚ ì§œ í™•ì¸
        const savedSelectedDate = localStorage.getItem("selectedDate");
        if (savedSelectedDate === dateKey || (!savedSelectedDate && isToday)) {
          dayDiv.classList.add("active");
          if (!savedSelectedDate) localStorage.setItem("selectedDate", dateKey);
        }

        dayDiv.innerHTML = `
          <div>${date}</div>
          <div class="day_text">${dayText}</div>
        `;

        dayDiv.addEventListener("click", () => {
          document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
          dayDiv.classList.add("active");
          localStorage.setItem("selectedDate", dateKey);
          location.reload(); // ë‚ ì§œ ë°”ë€Œë©´ ìƒˆë¡œê³ ì¹¨í•´ì„œ ë°ì´í„° ê°±ì‹ 
        });

        dateSelect.appendChild(dayDiv);
      }

      const selectedDate = localStorage.getItem("selectedDate") || getTodayDate();
      
      try {
        const [diets, dailyCalories] = await Promise.all([
          fetchDietList(selectedDate),
          fetchDailyCalories(selectedDate)
        ]);

        const mealTypes = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ê°„ì‹'];
        const mealsData = {};
        
        mealTypes.forEach(meal => {
          const englishTimeSlot = timeSlotMapping[meal];
          mealsData[meal] = diets.filter(diet => diet.time_slot === englishTimeSlot);
        });

        let totalKcal = 0;
        mealTypes.forEach(meal => {
          const meals = mealsData[meal] || [];
          const mealKcal = meals.reduce((acc, cur) => {
            return acc + (cur.total_kcal || 0);
          }, 0);

          const kcalSpan = [...document.querySelectorAll('.meal-item')].find(
            item => item.querySelector('.meal-name')?.textContent === meal
          )?.querySelector('.meal-kcal');

          if (kcalSpan) {
            kcalSpan.textContent = `${Math.round(mealKcal)}Kcal`;
            kcalSpan.classList.toggle('empty', mealKcal === 0);
          }

          totalKcal += mealKcal;
        });

        const totalKcalElement = document.querySelector('.calory-focus-num');
        const safeDisplayKcal = dailyCalories && !isNaN(Number(dailyCalories.total_kcal)) 
          ? Number(dailyCalories.total_kcal) 
          : totalKcal;

        if (totalKcalElement) {
          totalKcalElement.textContent = Math.round(safeDisplayKcal);
        }

        const safeTargetKcal = dailyCalories && !isNaN(Number(dailyCalories.target_kcal))
          ? Number(dailyCalories.target_kcal)
          : 1420;

        let percent = Math.min((safeDisplayKcal / safeTargetKcal) * 100, 100);
        if (isNaN(percent)) {
          percent = 0;
        }

        const barFill = document.querySelector('.bar-fill');
        if (barFill) {
          barFill.style.width = `${percent}%`;
        }

        const currentEl = document.getElementById("current-kcal");
        const goalEl = document.getElementById("goal-kcal");
        if (currentEl && goalEl) {
          currentEl.textContent = Math.round(safeDisplayKcal);
          goalEl.textContent = safeTargetKcal;
          
          const barPercent = Math.min((safeDisplayKcal / safeTargetKcal) * 100, 100);
          const caloryBar = document.getElementById("calory-bar");
          if (caloryBar) {
            caloryBar.style.width = `${barPercent}%`;
          }
        }

        document.querySelectorAll('.meal-add').forEach(btn => {
          btn.addEventListener('click', () => {
            const meal = btn.getAttribute('data-meal');
            const existingMeals = mealsData[meal] || [];

            localStorage.setItem('selectedMeal', meal);

            if (existingMeals.length > 0) {
              window.location.href = '/accounts/meal-edit/';
            } else {
              window.location.href = `/accounts/search/?meal=${encodeURIComponent(meal)}`;
            }
          });
        });

      } catch (error) {
        console.error("ì‹ë‹¨ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
        document.querySelector('.calory-focus-num').textContent = '0';
        document.querySelectorAll('.meal-kcal').forEach(el => {
          el.textContent = '0Kcal';
          el.classList.add('empty');
        });
      }

    });

    function toggleFeedback() {
      const panel = document.getElementById("feedback-panel");
      const arrow = document.getElementById("feedback-arrow-icon");
      const isOpen = panel.style.display === "block";
      panel.style.display = isOpen ? "none" : "block";
      arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
      arrow.alt = isOpen ? "ì—´ê¸° ì•„ì´ì½˜" : "ë‹«ê¸° ì•„ì´ì½˜";
    }

    function toggleexercise() {
      const panel = document.getElementById("exercise-panel");
      const arrow = document.getElementById("exercise-arrow-icon");
      const isOpen = panel.style.display === "block";
      panel.style.display = isOpen ? "none" : "block";
      arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
      arrow.alt = isOpen ? "ì—´ê¸° ì•„ì´ì½˜" : "ë‹«ê¸° ì•„ì´ì½˜";

      panel.style.animation = 'none';
      panel.offsetHeight; 
      panel.style.animation = '';
    }
</script>


</body>
</html>